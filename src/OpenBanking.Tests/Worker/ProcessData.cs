using Microsoft.Extensions.Logging;
using MongoDB.Bson;
using Newtonsoft.Json;
using NSubstitute;
using OpenBanking.Application.Entity;
using OpenBanking.Application.Interfaces;
using OpenBanking.Worker.Domain;
using OpenBanking.Worker.DTO;
using System.Collections.Generic;
using System.Reflection;

namespace OpenBanking.Tests.Worker
{
    public class ProcessData
    {
        private IBankDataService _bankDataService;
        private ILogger<DataProcessor> _logger;
        private DataProcessor _service;

        public ProcessData()
        {
            _bankDataService = Substitute.For<IBankDataService>();
            _logger = Substitute.For<ILogger<DataProcessor>>();

            _service = new DataProcessor(_bankDataService, _logger);
        }

        [Fact]
        public async Task ProcessDataResponseFromAPI()
        {
            string jsonString = "[{\"OrganisationId\":\"18543a69-338d-5e5b-8aa3-dc640ef5f4a2\",\"Status\":\"Active\",\"OrganisationName\":\"UNIPRIME CENTRAL CCC LTDA.\",\"CreatedOn\":\"2021-01-11T17:09:17.759Z\",\"LegalEntityName\":\"UNIPRIME CENTRAL - CENTRAL INTERESTADUAL DE COOPERATIVAS DE CREDITO LTDA.\",\"CountryOfRegistration\":\"BR\",\"CompanyRegister\":\"Cadastro Nacional da Pessoa Jurídica\",\"Tags\":[\"Cooperativas de Crédito Singulares, Centrais e Confederações\"],\"Flags\":{\"generated\":[\"Cooperativas de Crédito Singulares, Centrais e Confederações\"]},\"Size\":null,\"RegistrationNumber\":\"03046391000173\",\"RegistrationId\":\"03046391\",\"RegisteredName\":\"UNIPRIME CENTRAL - CENTRAL INTERESTADUAL DE COOPERATIVAS DE CREDITO LTDA.\",\"AddressLine1\":\"Avenida Higienopolis 1044, \",\"AddressLine2\":\"Centro\",\"City\":\"Londrina, PR\",\"Postcode\":\"86.020-080\",\"Country\":\"BR\",\"ParentOrganisationReference\":\"03046391000173\",\"AuthorisationServers\":[{\"AuthorisationServerId\":\"eaf49708-0c81-46bc-ac42-6b8378485544\",\"AutoRegistrationNotificationWebhook\":null,\"AutoRegistrationSupported\":true,\"CreatedAt\":1630071517,\"CustomerFriendlyDescription\":\"A Uniprime é uma Cooperativa de Crédito que atua há mais de 25 anos no mercado financeiro. Com foco em seus cooperados, a Uniprime preza por um relacionamento Prime, entregando valores sólidos e com segurança, através de negócios de alta performance.\",\"CustomerFriendlyLogoUri\":\"https://www.uniprime.com.br/themes/oficial/images/logo-uniprime.svg\",\"CustomerFriendlyName\":\"Uniprime Central\",\"DeprecatedDate\":null,\"DeveloperPortalUri\":\"https://developers.uniprimecentral.com.br\",\"FederationEndpoint\":null,\"FederationId\":null,\"Issuer\":\"https://auth.uniprimecentral.com.br/of-auth/realms/uniprimecentral\",\"NotificationWebhook\":null,\"NotificationWebhookAddedDate\":null,\"NotificationWebhookStatus\":null,\"OpenIDDiscoveryDocument\":\"https://auth.uniprimecentral.com.br/of-auth/realms/uniprimecentral/.well-known/openid-configuration\",\"OrganisationId\":\"18543a69-338d-5e5b-8aa3-dc640ef5f4a2\",\"ParentAuthorisationServerId\":null,\"PayloadSigningCertLocationUri\":\"https://auth.uniprimecentral.com.br/of-auth/realms/uniprimecentral/protocol/openid-connect/certs\",\"RetirementDate\":null,\"SupersededByAuthorisationServerId\":null,\"SupportsCiba\":false,\"SupportsDCR\":true,\"SupportsRedirect\":true,\"TermsOfServiceUri\":\"https://www.uniprimecentral.com.br/tos\",\"ApiResources\":[{\"ApiResourceId\":\"34556a27-ff24-4fc0-8531-a60accac6a61\",\"ApiVersion\":\"1\",\"FamilyComplete\":true,\"ApiCertificationUri\":null,\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":null,\"CertificationExpirationDate\":null,\"ApiFamilyType\":\"admin\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"b3836c51-dc09-48d8-9e1d-b1214ac535b6\",\"ApiEndpoint\":\"https://api.uniprimecentral.com.br/open-banking/admin/v1/metrics\"}]},{\"ApiResourceId\":\"f138d4bf-95fa-49e4-8cdb-51d1547a547f\",\"ApiVersion\":\"1\",\"FamilyComplete\":true,\"ApiCertificationUri\":null,\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":null,\"CertificationExpirationDate\":null,\"ApiFamilyType\":\"discovery\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"23240a33-1ce3-42ec-a5f0-92a73170f047\",\"ApiEndpoint\":\"https://api.uniprimecentral.com.br/open-banking/discovery/v1/outages\"},{\"ApiDiscoveryId\":\"6a0c9333-394c-4195-ba33-e0797f249d0b\",\"ApiEndpoint\":\"https://api.uniprimecentral.com.br/open-banking/discovery/v1/status\"}]},{\"ApiResourceId\":\"41bb7ba5-4997-48ec-8a7a-25567f408bdc\",\"ApiVersion\":\"3.0.0\",\"FamilyComplete\":true,\"ApiCertificationUri\":\"https://github.com/OpenBanking-Brasil/conformance/blob/main/submissions/functional/payments/3.0.0/03046391_uniprime-openfinance-payments-api-v3.0.0_payments_v3_17-01-2024.json\",\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":\"17/01/2024\",\"CertificationExpirationDate\":\"16/01/2025\",\"ApiFamilyType\":\"payments-pix\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"c03e2a74-8c84-4909-ab4e-4f15b1ec3c3e\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v3/pix/payments\"},{\"ApiDiscoveryId\":\"bf795056-771e-4cdc-a49f-c971cf999764\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v3/pix/payments/{paymentId}\"}]},{\"ApiResourceId\":\"e3a66562-e213-4aa5-8257-8e9d967e1927\",\"ApiVersion\":\"3.0.0\",\"FamilyComplete\":true,\"ApiCertificationUri\":\"https://github.com/OpenBanking-Brasil/conformance/blob/main/submissions/functional/payments/3.0.0/03046391_uniprime-openfinance-payments-api-v3.0.0_payments_v3_17-01-2024.json\",\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":\"17/01/2024\",\"CertificationExpirationDate\":\"16/01/2025\",\"ApiFamilyType\":\"payments-consents\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"e3ddf58e-04fb-4f45-bc7c-1b433063d70b\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v3/consents\"},{\"ApiDiscoveryId\":\"1e2d1b97-06df-424e-9eb6-3e3eaf0cb9d9\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v3/consents/{consentId}\"}]},{\"ApiResourceId\":\"f3269432-357d-4ab0-ace1-e977fdbcb667\",\"ApiVersion\":\"4.0.0\",\"FamilyComplete\":true,\"ApiCertificationUri\":\"https://github.com/OpenBanking-Brasil/conformance/blob/main/submissions/functional/payments/4.0.0/03046391_uniprime-openbanking-payments-v4.0.0_payments_v4.0_13-05-2024.json\",\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":\"13/05/2024\",\"CertificationExpirationDate\":\"13/05/2025\",\"ApiFamilyType\":\"payments-pix\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"be9212cf-d157-4129-8003-b01899089b81\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v4/pix/payments\"},{\"ApiDiscoveryId\":\"b11d17f9-ab36-496b-aae9-20bcddca64e4\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v4/pix/payments/{paymentId}\"},{\"ApiDiscoveryId\":\"b0997028-5703-4ef6-b07a-70255dd6d177\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v4/pix/payments/consents/{consentId}\"}]},{\"ApiResourceId\":\"78a2d09e-e620-4b88-8b72-a267ca4a316e\",\"ApiVersion\":\"2.0.0\",\"FamilyComplete\":true,\"ApiCertificationUri\":\"https://github.com/OpenBanking-Brasil/conformance/blob/main/submissions/functional/payments/2.0.0/03046391_Uniprime%20Central%20Open%20Finance%202.0.0_payments_v2_30-01-2023.zip\",\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":\"13/01/2023\",\"CertificationExpirationDate\":\"13/01/2024\",\"ApiFamilyType\":\"payments-pix\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"a47d98f0-7a92-4e59-8bfc-7e0fe4d7ee3b\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v2/pix/payments\"},{\"ApiDiscoveryId\":\"2d7d912a-f45a-4dc8-ba0b-68155632029c\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v2/pix/payments/{paymentId}\"}]},{\"ApiResourceId\":\"6bd3dee8-fdb6-44fb-8098-1c8d47ee8f9f\",\"ApiVersion\":\"2.0.0\",\"FamilyComplete\":true,\"ApiCertificationUri\":\"https://github.com/OpenBanking-Brasil/conformance/blob/main/submissions/functional/payments/2.0.0/03046391_Uniprime%20Central%20Open%20Finance%202.0.0_payments_v2_30-01-2023.zip\",\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":\"13/01/2023\",\"CertificationExpirationDate\":\"13/01/2024\",\"ApiFamilyType\":\"payments-consents\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"cac002bd-1874-40a4-aa11-6546117eff87\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v2/consents\"},{\"ApiDiscoveryId\":\"5a698c1b-5e15-4757-a308-2fcfe7f5e34a\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/payments/v2/consents/{consentId}\"}]},{\"ApiResourceId\":\"4d998cb4-7262-4cc8-8b61-9be2f56b7cc0\",\"ApiVersion\":\"2.0.0\",\"FamilyComplete\":true,\"ApiCertificationUri\":\"https://web.conformance.directory.openbankingbrasil.org.br/plan-detail.html?plan=Gusfdsa5Vy35n&public=true\",\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":\"22/05/2024\",\"CertificationExpirationDate\":\"22/05/2025\",\"ApiFamilyType\":\"discovery_outages\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"4441d364-f78c-4d47-a7e0-0e6534391f47\",\"ApiEndpoint\":\"https://auth.uniprimecentral.com.br/open-banking/discovery/v2/outages\"}]},{\"ApiResourceId\":\"4f5f651e-67ed-473a-86d4-a490f9f1c5ad\",\"ApiVersion\":\"2.0.0\",\"FamilyComplete\":true,\"ApiCertificationUri\":\"https://web.conformance.directory.openbankingbrasil.org.br/plan-detail.html?plan=3B2OQj3VKuhUx&public=true\",\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":\"22/05/2024\",\"CertificationExpirationDate\":\"22/05/2025\",\"ApiFamilyType\":\"admin\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"5007f9a9-aabc-4450-91fe-4b32c939b673\",\"ApiEndpoint\":\"https://api.uniprimecentral.com.br/open-banking/admin/v2/metrics\"}]},{\"ApiResourceId\":\"739a7845-b996-4f47-9008-4717c55a4261\",\"ApiVersion\":\"2.0.0\",\"FamilyComplete\":true,\"ApiCertificationUri\":\"https://web.conformance.directory.openbankingbrasil.org.br/plan-detail.html?plan=x93uoTANiD9tM&public=true\",\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":\"22/05/2024\",\"CertificationExpirationDate\":\"22/05/2025\",\"ApiFamilyType\":\"discovery_status\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"17299b58-060a-4fa8-bdf3-eb990c127226\",\"ApiEndpoint\":\"https://auth.uniprimecentral.com.br/open-banking/discovery/v2/status\"}]},{\"ApiResourceId\":\"2e10a58f-5627-48fe-ab99-58c4b7167e56\",\"ApiVersion\":\"1.0.0\",\"FamilyComplete\":true,\"ApiCertificationUri\":\"https://github.com/OpenBanking-Brasil/conformance/blob/main/submissions/functional/automatic-payments/1.0.0/03046391_uniprime-openfinance-automatic-payments-v1.0.0_automatic-payments_v1_29-04-2024.json\",\"CertificationStatus\":\"Self-Certified\",\"CertificationStartDate\":\"29/04/2024\",\"CertificationExpirationDate\":\"29/04/2025\",\"ApiFamilyType\":\"payments-pix-recurring-payments\",\"ApiDiscoveryEndpoints\":[{\"ApiDiscoveryId\":\"03230268-424b-4213-b0b5-b39342efb50c\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/automatic-payments/v1/pix/recurring-payments\"},{\"ApiDiscoveryId\":\"5a205f76-c3eb-43ae-8bc0-51b1aa3e0c8d\",\"ApiEndpoint\":\"https://mtls-auth.uniprimecentral.com.br/open-banking/automatic-payments/v1/pix/recurring-payments/{recurringPaymentId}\"}]}],\"AuthorisationServerCertifications\":[{\"CertificationStartDate\":\"01/02/2024\",\"CertificationExpirationDate\":\"31/01/2025\",\"CertificationId\":\"ad0701aa-2a3d-490d-b648-c4df5c8ac569\",\"AuthorisationServerId\":\"eaf49708-0c81-46bc-ac42-6b8378485544\",\"Status\":\"Self-Certified\",\"ProfileVariant\":\"BR-OF Adv. OP w/ Private Key, PAR (FAPI-BR v2)\",\"ProfileType\":\"Redirect\",\"ProfileVersion\":2,\"CertificationURI\":\"https://openid.net/wp-content/uploads/2024/02/Uniprime-Uniprime_Central_Open_Finance-BR-OF_ADV_OP_w_Private_Key_FAPI-BR-v2-1-Feb-2024.zip\"},{\"CertificationStartDate\":\"27/01/2024\",\"CertificationExpirationDate\":\"26/01/2025\",\"CertificationId\":\"9f29b0df-67d2-4a5b-8e87-40dfc39354dd\",\"AuthorisationServerId\":\"eaf49708-0c81-46bc-ac42-6b8378485544\",\"Status\":\"Self-Certified\",\"ProfileVariant\":\"BR-OF Adv. OP DCR (FAPI-BR v2)\",\"ProfileType\":\"Redirect\",\"ProfileVersion\":2,\"CertificationURI\":\"https://openid.net/wp-content/uploads/2024/02/Uniprime-Uniprime_Central_Open_Finance-BR-OF_ADV_OP_DCR_FAPI-BR-v2-27-Jan-2024.zip\"},{\"CertificationStartDate\":\"03/10/2022\",\"CertificationExpirationDate\":\"03/10/2023\",\"CertificationId\":\"469aab14-e3c1-4b4b-81a2-1f17d500c082\",\"AuthorisationServerId\":\"eaf49708-0c81-46bc-ac42-6b8378485544\",\"Status\":\"Self-Certified\",\"ProfileVariant\":\"DCR Signed payload - JWT\",\"ProfileType\":\"DCR\",\"ProfileVersion\":1,\"CertificationURI\":\"https://openid.net/wordpress-content/uploads/2022/10/Uniprime_Central-Uniprime_Central_Open_Finance-BR-OB_ADV_OP_DCR-3-Oct-2022.zip\"},{\"CertificationStartDate\":\"11/10/2022\",\"CertificationExpirationDate\":\"11/10/2023\",\"CertificationId\":\"e56ffa1f-33bc-49da-b086-5cb4de13e225\",\"AuthorisationServerId\":\"eaf49708-0c81-46bc-ac42-6b8378485544\",\"Status\":\"Self-Certified\",\"ProfileVariant\":\"FAPI Adv. OP w/ MTLS\",\"ProfileType\":\"Redirect\",\"ProfileVersion\":1,\"CertificationURI\":\"https://openid.net/wordpress-content/uploads/2022/10/Uniprime_Central-Uniprime_Central_Open_Finance-BR-OB_ADV_OP_w_MTLS-11-Oct-2022.zip\"}],\"Flags\":{\"Suporta Contas PF\":[\"Suporta Contas PF\"],\"Suporta Contas PJ\":[\"Suporta Contas PJ\"]}}],\"OrgDomainClaims\":[{\"AuthorisationDomainName\":\"Open Banking\",\"AuthorityName\":\"Banco Central do Brasil\",\"RegistrationId\":\"\",\"Status\":\"Active\"}],\"OrgDomainRoleClaims\":[{\"Status\":\"Active\",\"AuthorisationDomain\":\"Open Banking\",\"Role\":\"CONTA\",\"RegistrationId\":\"03046391-OBB-CONTA\",\"Authorisations\":[],\"RoleType\":\"Federation\",\"Exclusive\":false,\"Metadata\":[]},{\"Status\":\"Active\",\"AuthorisationDomain\":\"Open Banking\",\"Role\":\"PAGTO\",\"RegistrationId\":\"030246291-OBB-PAGTO\",\"Authorisations\":[],\"RoleType\":\"Federation\",\"Exclusive\":false,\"Metadata\":[]}]}]";
            var expectedData = JsonConvert.DeserializeObject<List<CompanyData>>(jsonString)
            ?.FirstOrDefault()
            ?.ToBankData();

            await _service.Process(jsonString);

            _bankDataService.Received()
                .SaveOrUpdate(Arg.Is<BankData>(db => db.Name.Equals(expectedData.Name) && 
                    db.Status.Equals(expectedData.Status)));
        }
    }
}
